# ---------- builder ----------
FROM gradle:8.10.2-jdk17-alpine AS builder
WORKDIR /workspace

# (ì˜µì…˜) ìºì‹œ ìµœì í™”: ì˜ì¡´ì„± ë¨¼ì € ë°›ê¸°
COPY build.gradle settings.gradle ./
COPY gradle gradle
RUN gradle --version

# ì‹¤ì œ ì†ŒìŠ¤ ë³µì‚¬ í›„ ë¹Œë“œ
COPY . .
RUN gradle clean bootJar --no-daemon

# --------- ì‹¤í–‰ìš© ì´ë¯¸ì§€ êµ¬ì„± ---------
FROM eclipse-temurin:17-jre-alpine
WORKDIR /app

# ë³´ì•ˆìƒ root ëŒ€ì‹  ë¹„ë£¨íŠ¸ ì‚¬ìš©ì(app) ìƒì„±. -SëŠ” ì‹œìŠ¤í…œ ê³„ì •/ê·¸ë£¹(ê°€ë²¼ì›€)
RUN addgroup -S app && adduser -S app -G app
RUN mkdir -p /app/config && chown -R app:app /app

# ë¹Œë“œ ì‚°ì¶œë¬¼ ë³µì‚¬
COPY --from=builder /workspace/build/libs/*.jar /app/app.jar
# application.yml ë³µì‚¬ (JAR ì•ˆì—ì„œ ì°¸ì¡°ë  ìœ„ì¹˜ë¡œ) / ğŸ”‘ yml ì†Œìœ ìë¥¼ appìœ¼ë¡œ ì§€ì •
COPY --chown=app:app application.yml /app/config/application.yml

USER app
EXPOSE 8081
ENTRYPOINT ["java", "-jar", "/app/app.jar", "--spring.config.location=file:/app/config/application.yml"]
